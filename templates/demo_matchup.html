{% extends "base.html" %}

{% block title %}Matchup Simulator - Demo Mode{% endblock %}

{% block content %}

<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-vs"></i> Matchup Simulator</h1>
        <p class="lead text-muted">Monte Carlo simulation analysis for your weekly matchup</p>
        <hr>
    </div>
</div>

{% if not my_roster or my_roster|length == 0 %}
<!-- No team selected -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> 
            <strong>You must select your team first!</strong> 
            <a href="{{ url_for('index') }}" class="btn btn-sm btn-primary ms-2">Go to Home Page</a>
        </div>
    </div>
</div>
{% else %}

<!-- Team Selection Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> Select Opponent Team</h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#selectOpponentModal">
                        <i class="fas fa-user-plus"></i> Select Opponent Team
                    </button>
                </div>
                {% if opponent_roster and opponent_roster|length > 0 %}
                <div class="mt-3">
                    <span class="badge bg-success me-2">
                        <i class="fas fa-check"></i> Opponent team selected ({{ opponent_roster|length }} players)
                    </span>
                    <span class="badge bg-info fs-6">
                        <i class="fas fa-coins"></i> Opponent Credit: {{ opponent_team_credit }}/200
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if simulation %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Win Probability</h5>
                <div class="{% if simulation.win_probability >= 60 %}win-prob-high{% elif simulation.win_probability >= 40 %}win-prob-medium{% else %}win-prob-low{% endif %}">
                    {{ simulation.win_probability }}%
                </div>
                <p class="text-muted">{{ "{:,}".format(10000) }} simulations</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Category Score (9 Categories)</h5>
                <div class="display-4 fw-bold" style="color: #0d6efd;">
                    <span class="{% if simulation.expected_categories_won > simulation.expected_categories_lost %}text-success{% elif simulation.expected_categories_won < simulation.expected_categories_lost %}text-danger{% else %}text-warning{% endif %}">
                        {{ simulation.expected_categories_won }}
                    </span>
                    <span class="text-muted"> - </span>
                    <span class="text-secondary">{{ simulation.expected_categories_lost }}</span>
                </div>
                <p class="text-muted small mt-2">
                    <i class="fas fa-trophy"></i> Won Categories - Lost Categories
                    {% if simulation.expected_categories_tied > 0 %}
                    <br><span class="badge bg-warning text-dark">{{ simulation.expected_categories_tied }} Tied</span>
                    {% endif %}
                </p>
                <small class="text-info">
                    <i class="fas fa-info-circle"></i> 
                    PTS, REB, AST, STL, BLK, 3PM, FG%, FT%, TO
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> 9 Category Detailed Analysis</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th class="text-center">My Team</th>
                                <th class="text-center">Opponent</th>
                                <th class="text-center">Win Probability</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set stat_names = {
                                'points': 'Points (PTS)',
                                'rebounds': 'Rebounds (REB)',
                                'assists': 'Assists (AST)',
                                'steals': 'Steals (STL)',
                                'blocks': 'Blocks (BLK)',
                                'three_pointers_made': '3-Pointers (3PM)',
                                'fg_percentage': 'Field Goal % (FG%)',
                                'ft_percentage': 'Free Throw % (FT%)',
                                'turnovers': 'Turnovers (TO)'
                            } %}
                            
                            {% for category in ['points', 'rebounds', 'assists', 'steals', 'blocks', 'three_pointers_made', 'fg_percentage', 'ft_percentage', 'turnovers'] %}
                            {% if category in simulation.category_breakdown %}
                            {% set data = simulation.category_breakdown[category] %}
                            {% set my_val = simulation.my_team_projections[category] %}
                            {% set opp_val = simulation.opponent_projections[category] %}
                            <tr>
                                <td><strong>{{ stat_names[category] }}</strong></td>
                                <td class="text-center">
                                    {% if category in ['fg_percentage', 'ft_percentage'] %}
                                        <strong>{{ (my_val * 100)|round(1) }}%</strong>
                                    {% else %}
                                        <strong>{{ my_val|round(1) }}</strong>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if category in ['fg_percentage', 'ft_percentage'] %}
                                        <strong>{{ (opp_val * 100)|round(1) }}%</strong>
                                    {% else %}
                                        <strong>{{ opp_val|round(1) }}</strong>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-{% if data.strength == 'strong' %}success{% elif data.strength == 'weak' %}danger{% else %}warning{% endif %}" 
                                             style="width: {{ data.win_pct }}%">
                                            {{ data.win_pct }}%
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {% if data.strength == 'strong' %}
                                        <span class="badge bg-success"><i class="fas fa-check-circle"></i> Strong</span>
                                    {% elif data.strength == 'weak' %}
                                        <span class="badge bg-danger"><i class="fas fa-times-circle"></i> Weak</span>
                                    {% else %}
                                        <span class="badge bg-warning"><i class="fas fa-minus-circle"></i> Balanced</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-user"></i> My Team</h5>
            </div>
            <div class="card-body">
                {% if my_roster %}
                    {% for player in my_roster %}
                    <div class="player-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ player.name }}</strong>
                                <br>
                                <small class="text-muted">{{ player.position }} - {{ player.team }}</small>
                            </div>
                            <div class="text-end">
                                <small>
                                    <span class="badge bg-info">{{ player.stats.points|default(0)|round(1) }} PPG</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
                
                {% if simulation and simulation.my_team_projections %}
                <hr>
                <h6>Team Totals (Weekly Projection)</h6>
                <div class="row text-center small">
                    <div class="col-4 col-md-3 mb-2">
                        <div class="border p-2">
                            <strong>{{ "%.1f"|format(simulation.my_team_projections.points) }}</strong>
                            <br><small>PTS</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-3 mb-2">
                        <div class="border p-2">
                            <strong>{{ "%.1f"|format(simulation.my_team_projections.rebounds) }}</strong>
                            <br><small>REB</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-3 mb-2">
                        <div class="border p-2">
                            <strong>{{ "%.1f"|format(simulation.my_team_projections.assists) }}</strong>
                            <br><small>AST</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-3 mb-2">
                        <div class="border p-2">
                            <strong>{{ "%.1f"|format(simulation.my_team_projections.steals) }}</strong>
                            <br><small>STL</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-3 mb-2">
                        <div class="border p-2">
                            <strong>{{ "%.1f"|format(simulation.my_team_projections.blocks) }}</strong>
                            <br><small>BLK</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-3 mb-2">
                        <div class="border p-2">
                            <strong>{{ "%.1f"|format(simulation.my_team_projections.three_pointers_made) }}</strong>
                            <br><small>3PM</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-3 mb-2">
                        <div class="border p-2">
                            <strong>{{ "%.1f"|format(simulation.my_team_projections.fg_percentage * 100) }}%</strong>
                            <br><small>FG%</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-3 mb-2">
                        <div class="border p-2">
                            <strong>{{ "%.1f"|format(simulation.my_team_projections.ft_percentage * 100) }}%</strong>
                            <br><small>FT%</small>
                        </div>
                    </div>
                    <div class="col-4 col-md-3 mb-2">
                        <div class="border p-2">
                            <strong>{{ "%.1f"|format(simulation.my_team_projections.turnovers) }}</strong>
                            <br><small>TO</small>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-user-friends"></i> Opponent Team</h5>
            </div>
            <div class="card-body">
                {% if opponent_roster and opponent_roster|length > 0 %}
                    {% for player in opponent_roster %}
                    <div class="player-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ player.name }}</strong>
                                <br>
                                <small class="text-muted">{{ player.position }} - {{ player.team }}</small>
                            </div>
                            <div class="text-end">
                                <small>
                                    <span class="badge bg-info">{{ player.stats.points|default(0)|round(1) }} PPG</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if simulation and simulation.opponent_projections %}
                    <hr>
                    <h6>Team Totals (Weekly Projection)</h6>
                    <div class="row text-center small">
                        <div class="col-4 col-md-3 mb-2">
                            <div class="border p-2">
                                <strong>{{ "%.1f"|format(simulation.opponent_projections.points) }}</strong>
                                <br><small>PTS</small>
                            </div>
                        </div>
                        <div class="col-4 col-md-3 mb-2">
                            <div class="border p-2">
                                <strong>{{ "%.1f"|format(simulation.opponent_projections.rebounds) }}</strong>
                                <br><small>REB</small>
                            </div>
                        </div>
                        <div class="col-4 col-md-3 mb-2">
                            <div class="border p-2">
                                <strong>{{ "%.1f"|format(simulation.opponent_projections.assists) }}</strong>
                                <br><small>AST</small>
                            </div>
                        </div>
                        <div class="col-4 col-md-3 mb-2">
                            <div class="border p-2">
                                <strong>{{ "%.1f"|format(simulation.opponent_projections.steals) }}</strong>
                                <br><small>STL</small>
                            </div>
                        </div>
                        <div class="col-4 col-md-3 mb-2">
                            <div class="border p-2">
                                <strong>{{ "%.1f"|format(simulation.opponent_projections.blocks) }}</strong>
                                <br><small>BLK</small>
                            </div>
                        </div>
                        <div class="col-4 col-md-3 mb-2">
                            <div class="border p-2">
                                <strong>{{ "%.1f"|format(simulation.opponent_projections.three_pointers_made) }}</strong>
                                <br><small>3PM</small>
                            </div>
                        </div>
                        <div class="col-4 col-md-3 mb-2">
                            <div class="border p-2">
                                <strong>{{ "%.1f"|format(simulation.opponent_projections.fg_percentage * 100) }}%</strong>
                                <br><small>FG%</small>
                            </div>
                        </div>
                        <div class="col-4 col-md-3 mb-2">
                            <div class="border p-2">
                                <strong>{{ "%.1f"|format(simulation.opponent_projections.ft_percentage * 100) }}%</strong>
                                <br><small>FT%</small>
                            </div>
                        </div>
                        <div class="col-4 col-md-3 mb-2">
                            <div class="border p-2">
                                <strong>{{ "%.1f"|format(simulation.opponent_projections.turnovers) }}</strong>
                                <br><small>TO</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                        <h5>No Opponent Selected</h5>
                        <p class="text-muted">Use the buttons above to select an opponent</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if simulation.recommendations %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb"></i> Strategic Recommendations</h5>
            </div>
            <div class="card-body">
                {% for rec in simulation.recommendations %}
                <div class="alert alert-{% if rec.priority == 'high' %}warning{% else %}info{% endif %}">
                    <i class="fas fa-{% if rec.type == 'improve_weakness' %}arrow-up{% else %}star{% endif %}"></i>
                    {{ rec.message }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Simulation Controls</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if opponent_roster and opponent_roster|length > 0 %}
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="rerunSimulation()">
                            <i class="fas fa-redo"></i> Rerun Simulation
                        </button>
                    </div>
                    {% endif %}
                    <div class="col-md-4">
                        <button class="btn btn-warning w-100" onclick="clearOpponent()">
                            <i class="fas fa-trash"></i> Clear Opponent
                        </button>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary w-100">
                            <i class="fas fa-home"></i> Back to Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}

<!-- Opponent Selection Modal -->
<div class="modal fade" id="selectOpponentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div class="w-100">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="modal-title mb-0">Opponent Players (0/10)</h5>
                        <div class="text-end">
                            <button class="btn btn-success btn-sm me-2" onclick="selectRandomOpponentInModal()" id="randomOppBtn">
                                <i class="fas fa-random"></i> Generate Random
                            </button>
                            <div class="badge bg-danger text-white fs-6" id="oppCreditDisplay">
                                <i class="fas fa-coins"></i> Credit: <span id="oppCurrentCredit">0</span>/200
                            </div>
                            <div>
                                <small class="text-muted">Remaining: <span id="oppRemainingCredit" class="text-success fw-bold">200</span></small>
                            </div>
                        </div>
                    </div>
                    <small class="text-muted" id="oppPositionRequirement">
                        Roster Positions: 
                        <span id="oppPgSlotStatus" class="badge bg-secondary">PG</span>
                        <span id="oppSgSlotStatus" class="badge bg-secondary">SG</span>
                        <span id="oppGSlotStatus" class="badge bg-secondary">G</span>
                        <span id="oppSfSlotStatus" class="badge bg-secondary">SF</span>
                        <span id="oppPfSlotStatus" class="badge bg-secondary">PF</span>
                        <span id="oppFSlotStatus" class="badge bg-secondary">F</span>
                        <span id="oppC1SlotStatus" class="badge bg-secondary">C</span>
                        <span id="oppC2SlotStatus" class="badge bg-secondary">C</span>
                        <span id="oppUtil1SlotStatus" class="badge bg-secondary">UTIL</span>
                        <span id="oppUtil2SlotStatus" class="badge bg-secondary">UTIL</span>
                    </small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <input type="text" id="opponentSearch" class="form-control form-control-sm" placeholder="🔍 Search player...">
                    </div>
                    <div class="col-md-2">
                        <select id="oppPositionFilter" class="form-select form-select-sm">
                            <option value="">All Positions</option>
                            <option value="PG">Point Guard (PG)</option>
                            <option value="SG">Shooting Guard (SG)</option>
                            <option value="G">Guard (G - PG/SG)</option>
                            <option value="SF">Small Forward (SF)</option>
                            <option value="PF">Power Forward (PF)</option>
                            <option value="F">Forward (F - SF/PF)</option>
                            <option value="C">Center (C)</option>
                            <option value="UTIL">Utility (UTIL - Everyone)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="oppTeamFilter" class="form-select form-select-sm">
                            <option value="">All Teams</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="oppSortBy" class="form-select form-select-sm">
                            <option value="credit">💰 Credit</option>
                            <option value="points">Points (PTS)</option>
                            <option value="rebounds">Rebounds (REB)</option>
                            <option value="assists">Assists (AST)</option>
                            <option value="steals">Steals (ST)</option>
                            <option value="blocks">Blocks (BLK)</option>
                            <option value="threes">3-Pointers (3PM)</option>
                            <option value="fg_percentage">Field Goal % (FG%)</option>
                            <option value="ft_percentage">Free Throw % (FT%)</option>
                            <option value="turnovers">Turnovers (TO)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetOppFilters()">
                            <i class="fas fa-redo"></i> Clear Filters
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover table-sm">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>Name</th>
                                <th>Pos</th>
                                <th>Team</th>
                                <th>💰</th>
                                <th>PTS</th>
                                <th>REB</th>
                                <th>AST</th>
                                <th>ST</th>
                                <th>BLK</th>
                                <th>3PTM</th>
                                <th>FG%</th>
                                <th>FT%</th>
                                <th>TO</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="opponentTableBody">
                            {% for player in all_players %}
                            {% if player.name not in my_roster|map(attribute='name')|list %}
                            <tr class="opp-player-row" data-player-name="{{ player.name }}"
                                data-position="{{ player.position }}"
                                data-team="{{ player.team }}"
                                data-player-credit="0"
                                data-points="{{ player.stats.points|default(0)|round(1) }}"
                                data-rebounds="{{ player.stats.rebounds|default(0)|round(1) }}"
                                data-assists="{{ player.stats.assists|default(0)|round(1) }}"
                                data-steals="{{ player.stats.steals|default(0)|round(2) }}"
                                data-blocks="{{ player.stats.blocks|default(0)|round(2) }}"
                                data-fg-pct="{{ (player.stats.fg_percentage * 100)|round(1) if player.stats.fg_percentage else 0 }}"
                                data-ft-pct="{{ (player.stats.ft_percentage * 100)|round(1) if player.stats.ft_percentage else 0 }}"
                                data-threes="{{ player.stats.three_pointers_made|default(0)|round(1) }}">
                                <td><strong>{{ player.name }}</strong></td>
                                <td><span class="badge bg-info">{{ player.position }}</span></td>
                                <td>{{ player.team }}</td>
                                <td><span class="badge opp-credit-badge bg-secondary">-</span></td>
                                <td>{{ player.stats.points|default(0)|round(1) }}</td>
                                <td>{{ player.stats.rebounds|default(0)|round(1) }}</td>
                                <td>{{ player.stats.assists|default(0)|round(1) }}</td>
                                <td>{{ player.stats.steals|default(0)|round(2) }}</td>
                                <td>{{ player.stats.blocks|default(0)|round(2) }}</td>
                                <td>{{ player.stats.three_pointers_made|default(0)|round(1) }}</td>
                                <td>{{ (player.stats.fg_percentage * 100)|round(1) if player.stats.fg_percentage else '-' }}%</td>
                                <td>{{ (player.stats.ft_percentage * 100)|round(1) if player.stats.ft_percentage else '-' }}%</td>
                                <td>{{ player.stats.turnovers|default(0)|round(1) }}</td>
                                <td>
                                    <button class="btn btn-sm btn-success add-opponent-btn" 
                                            data-player="{{ player.name }}"
                                            data-position="{{ player.position }}">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-danger" id="oppValidationMessage"></small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveOpponent()" id="saveOppBtn">
                    Kaydet ve simulations Ã‡alÄ±ÅŸtÄ±r
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let opponentTeam = [];
let opponentRoster = {
    PG: null, SG: null, G: null, SF: null, PF: null,
    F: null, C1: null, C2: null, UTIL1: null, UTIL2: null
};
let playerRankings = []; // Will store credit values
const allPlayers = {{ all_players|tojson|safe }};

// Load player credits from rankings API
function loadOpponentCredits() {
    fetch('/api/draft/rankings')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                playerRankings = data.rankings;
                
                // Update credit badges in table
                document.querySelectorAll('.opp-player-row').forEach(row => {
                    const playerName = row.dataset.playerName;
                    const ranking = playerRankings.find(r => r.name === playerName);
                    
                    if (ranking) {
                        const credit = ranking.credit || 0;
                        row.dataset.playerCredit = credit;
                        
                        const badge = row.querySelector('.opp-credit-badge');
                        if (badge) {
                            badge.textContent = credit;
                            badge.className = 'badge opp-credit-badge';
                            if (credit >= 50) {
                                badge.classList.add('bg-danger');
                            } else if (credit >= 35) {
                                badge.classList.add('bg-warning', 'text-dark');
                            } else if (credit >= 20) {
                                badge.classList.add('bg-info');
                            } else {
                                badge.classList.add('bg-success');
                            }
                        }
                    }
                });
                
                updateOppCreditDisplay();
                console.log('Loaded credits for opponent selection');
            }
        })
        .catch(err => console.error('Error loading credits:', err));
}

// Update opponent credit display
function updateOppCreditDisplay() {
    let totalCredit = 0;
    
    opponentTeam.forEach(playerName => {
        const ranking = playerRankings.find(r => r.name === playerName);
        if (ranking) {
            totalCredit += ranking.credit || 0;
        }
    });
    
    const remainingCredit = 200 - totalCredit;
    
    const currentDisplay = document.getElementById('oppCurrentCredit');
    const remainingDisplay = document.getElementById('oppRemainingCredit');
    
    if (currentDisplay) {
        currentDisplay.textContent = totalCredit;
    }
    
    if (remainingDisplay) {
        remainingDisplay.textContent = remainingCredit;
        remainingDisplay.className = remainingCredit >= 50 ? 'text-success fw-bold' : 
                                     remainingCredit >= 20 ? 'text-warning fw-bold' : 
                                     'text-danger fw-bold';
    }
}

// Assign player to opponent roster slot
function assignToOpponentSlot(player) {
    const positions = player.position.split('-');
    
    // Try to assign to specific position first
    for (let pos of positions) {
        if (pos === 'PG' && !opponentRoster.PG) {
            opponentRoster.PG = player.name;
            return;
        }
        if (pos === 'SG' && !opponentRoster.SG) {
            opponentRoster.SG = player.name;
            return;
        }
        if (pos === 'SF' && !opponentRoster.SF) {
            opponentRoster.SF = player.name;
            return;
        }
        if (pos === 'PF' && !opponentRoster.PF) {
            opponentRoster.PF = player.name;
            return;
        }
        if (pos === 'C' && !opponentRoster.C1) {
            opponentRoster.C1 = player.name;
            return;
        }
        if (pos === 'C' && !opponentRoster.C2) {
            opponentRoster.C2 = player.name;
            return;
        }
    }
    
    // Try G slot (PG or SG)
    if ((positions.includes('PG') || positions.includes('SG')) && !opponentRoster.G) {
        opponentRoster.G = player.name;
        return;
    }
    
    // Try F slot (SF or PF)
    if ((positions.includes('SF') || positions.includes('PF')) && !opponentRoster.F) {
        opponentRoster.F = player.name;
        return;
    }
    
    // Try UTIL slots
    if (!opponentRoster.UTIL1) {
        opponentRoster.UTIL1 = player.name;
        return;
    }
    if (!opponentRoster.UTIL2) {
        opponentRoster.UTIL2 = player.name;
        return;
    }
}

// Update opponent roster status badges
function updateOpponentRosterStatus() {
    const slotMapping = {
        'PG': 'oppPgSlotStatus',
        'SG': 'oppSgSlotStatus',
        'G': 'oppGSlotStatus',
        'SF': 'oppSfSlotStatus',
        'PF': 'oppPfSlotStatus',
        'F': 'oppFSlotStatus',
        'C1': 'oppC1SlotStatus',
        'C2': 'oppC2SlotStatus',
        'UTIL1': 'oppUtil1SlotStatus',
        'UTIL2': 'oppUtil2SlotStatus'
    };
    
    Object.keys(slotMapping).forEach(slot => {
        const badge = document.getElementById(slotMapping[slot]);
        if (badge) {
            const isFilled = opponentRoster[slot] !== null;
            let displayName = slot;
            if (slot === 'C1' || slot === 'C2') displayName = 'C';
            if (slot === 'UTIL1' || slot === 'UTIL2') displayName = 'UTIL';
            
            badge.textContent = displayName;
            badge.className = isFilled ? 'badge bg-success' : 'badge bg-secondary';
        }
    });
}

// Initialize team filter
const uniqueTeams = [...new Set(allPlayers.map(p => p.team))].sort();
const oppTeamFilter = document.getElementById('oppTeamFilter');
if (oppTeamFilter) {
    uniqueTeams.forEach(team => {
        const option = document.createElement('option');
        option.value = team;
        option.textContent = team;
        oppTeamFilter.appendChild(option);
    });
}

// Opponent filters
document.getElementById('opponentSearch')?.addEventListener('input', applyOppFilters);
document.getElementById('oppPositionFilter')?.addEventListener('change', applyOppFilters);
document.getElementById('oppTeamFilter')?.addEventListener('change', applyOppFilters);
document.getElementById('oppSortBy')?.addEventListener('change', applyOppFilters);

function applyOppFilters() {
    const searchTerm = document.getElementById('opponentSearch')?.value.toLowerCase() || '';
    const posFilter = document.getElementById('oppPositionFilter')?.value || '';
    const teamFilterVal = document.getElementById('oppTeamFilter')?.value || '';
    const sortBy = document.getElementById('oppSortBy')?.value || 'credit';
    
    const rows = Array.from(document.querySelectorAll('#opponentTableBody tr'));
    
    // Filter
    rows.forEach(row => {
        const playerName = row.dataset.playerName.toLowerCase();
        const position = row.dataset.position;
        const team = row.dataset.team;
        
        let show = true;
        
        if (searchTerm && !playerName.includes(searchTerm)) show = false;
        
        // Handle special position filters (same as index.html)
        if (posFilter) {
            if (posFilter === 'G') {
                if (!position.includes('PG') && !position.includes('SG')) show = false;
            } else if (posFilter === 'F') {
                if (!position.includes('SF') && !position.includes('PF')) show = false;
            } else if (posFilter === 'UTIL') {
                show = true;
            } else {
                if (!position.includes(posFilter)) show = false;
            }
        }
        
        if (teamFilterVal && team !== teamFilterVal) show = false;
        
        row.style.display = show ? '' : 'none';
    });
    
    // Sort visible rows
    const visibleRows = rows.filter(row => row.style.display !== 'none');
    visibleRows.sort((a, b) => {
        let aVal, bVal;
        
        if (sortBy === 'credit') {
            aVal = parseFloat(a.dataset.playerCredit || 0);
            bVal = parseFloat(b.dataset.playerCredit || 0);
        } else if (sortBy === 'fg_percentage' || sortBy === 'ft_percentage') {
            const fieldName = sortBy === 'fg_percentage' ? 'fgPct' : 'ftPct';
            aVal = parseFloat(a.dataset[fieldName] || 0);
            bVal = parseFloat(b.dataset[fieldName] || 0);
        } else {
            aVal = parseFloat(a.dataset[sortBy] || 0);
            bVal = parseFloat(b.dataset[sortBy] || 0);
        }
        
        // For turnovers, lower is better
        if (sortBy === 'turnovers') {
            return aVal - bVal;
        }
        
        // For all other stats, higher is better
        return bVal - aVal;
    });
    
    const tbody = document.getElementById('opponentTableBody');
    visibleRows.forEach(row => tbody.appendChild(row));
}

function resetOppFilters() {
    document.getElementById('opponentSearch').value = '';
    document.getElementById('oppPositionFilter').value = '';
    document.getElementById('oppTeamFilter').value = '';
    document.getElementById('oppSortBy').value = 'credit';
    applyOppFilters();
}

function addToOpponent(playerName, position) {
    if (opponentTeam.length >= 10) {
        showOppValidationMessage('Maximum 10 players can be selected!');
        return;
    }
    
    if (opponentTeam.includes(playerName)) {
        showOppValidationMessage('This player is already selected!');
        return;
    }
    
    // Calculate current credit
    let currentCredit = 0;
    opponentTeam.forEach(pName => {
        const ranking = playerRankings.find(r => r.name === pName);
        if (ranking) {
            currentCredit += ranking.credit || 0;
        }
    });
    
    // Get new player's credit
    const newPlayerRanking = playerRankings.find(r => r.name === playerName);
    const newPlayerCredit = newPlayerRanking ? (newPlayerRanking.credit || 0) : 0;
    
    // Check credit limit
    if (currentCredit + newPlayerCredit > 200) {
        showOppValidationMessage(`Credit limit exceeded! Current: ${currentCredit}, To add: ${newPlayerCredit}`);
        return;
    }
    
    // Add player
    opponentTeam.push(playerName);
    const player = allPlayers.find(p => p.name === playerName);
    if (player) {
        assignToOpponentSlot(player);
    }
    
    updateOpponentModal();
    updateOpponentRosterStatus();
    updateOppCreditDisplay();
    validateOppTeam();
}

function removeFromOpponent(playerName) {
    // Remove from array
    opponentTeam = opponentTeam.filter(name => name !== playerName);
    
    // Remove from roster slots
    Object.keys(opponentRoster).forEach(slot => {
        if (opponentRoster[slot] === playerName) {
            opponentRoster[slot] = null;
        }
    });
    
    updateOpponentModal();
    updateOpponentRosterStatus();
    updateOppCreditDisplay();
    validateOppTeam();
}

function validateOppTeam() {
    const totalSlots = 10;
    const filledSlots = opponentTeam.length;
    
    const saveBtn = document.getElementById('saveOppBtn');
    const validationMsg = document.getElementById('oppValidationMessage');
    
    if (filledSlots < totalSlots) {
        saveBtn.disabled = true;
        validationMsg.textContent = `${filledSlots}/10 players selected. Team not complete!`;
    } else if (filledSlots === totalSlots) {
        // Check credit is close to 200
        let totalCredit = 0;
        opponentTeam.forEach(pName => {
            const ranking = playerRankings.find(r => r.name === pName);
            if (ranking) {
                totalCredit += ranking.credit || 0;
            }
        });
        
        if (totalCredit < 180) {
            saveBtn.disabled = true;
            validationMsg.textContent = `Total credit too low: ${totalCredit}/200. Use at least 180 credits!`;
        } else {
            saveBtn.disabled = false;
            validationMsg.textContent = '';
        }
    } else {
        saveBtn.disabled = true;
        validationMsg.textContent = 'Maximum 10 players can be selected!';
    }
}

function showOppValidationMessage(message) {
    const validationMsg = document.getElementById('oppValidationMessage');
    if (validationMsg) {
        validationMsg.textContent = message;
        setTimeout(() => {
            validationMsg.textContent = '';
        }, 3000);
    }
}

function updateOpponentModal() {
    const modalTitle = document.querySelector('#selectOpponentModal .modal-title');
    if (modalTitle) {
        modalTitle.textContent = `Select Opponent Players (${opponentTeam.length}/10)`;
    }
    
    const addButtons = document.querySelectorAll('.add-opponent-btn');
    addButtons.forEach(btn => {
        const playerName = btn.dataset.player;
        if (opponentTeam.includes(playerName)) {
            // Player already added - show remove button
            btn.classList.remove('btn-success');
            btn.classList.add('btn-danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-times"></i> Remove';
            btn.onclick = function(e) {
                e.preventDefault();
                removeFromOpponent(playerName);
            };
        } else if (opponentTeam.length >= 10) {
            // Team full
            btn.classList.remove('btn-success', 'btn-danger');
            btn.classList.add('btn-secondary');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-ban"></i> Full';
        } else {
            // Available to add
            btn.classList.remove('btn-secondary', 'btn-danger');
            btn.classList.add('btn-success');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus"></i> Add';
            const position = btn.dataset.position;
            btn.onclick = function(e) {
                e.preventDefault();
                addToOpponent(playerName, position);
            };
        }
    });
}

function saveOpponent() {
    if (opponentTeam.length < 10) {
        alert(`Team not complete! ${opponentTeam.length}/10 players selected.`);
        return;
    }
    
    // Calculate total credit
    let totalCredit = 0;
    opponentTeam.forEach(playerName => {
        const ranking = playerRankings.find(r => r.name === playerName);
        if (ranking) {
            totalCredit += ranking.credit || 0;
        }
    });
    
    if (totalCredit < 180) {
        alert(`Total credit too low: ${totalCredit}/200. Use at least 180 credits!`);
        return;
    }
    
    if (totalCredit > 200) {
        alert(`Credit limit exceeded! Total: ${totalCredit}/200`);
        return;
    }
    
    fetch('/api/save-opponent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ team: opponentTeam })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Could not save team!');
    });
}

function selectRandomOpponentInModal() {
    const btn = document.getElementById('randomOppBtn');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    btn.disabled = true;
    
    fetch('/api/random-opponent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Populate the modal with selected players
            opponentTeam = data.team;
            
            // Update modal UI
            updateOpponentModal();
            updateOpponentRosterStatus();
            updateOppCreditDisplay();
            validateOppTeam();
            
            // Show success message
            const validationMsg = document.getElementById('oppValidationMessage');
            if (validationMsg) {
                validationMsg.className = 'text-success';
                validationMsg.textContent = `Random team created! Total Credit: ${data.total_credit}/200`;
                setTimeout(() => {
                    validationMsg.className = 'text-danger';
                    validationMsg.textContent = '';
                }, 3000);
            }
            
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Could not create random team!');
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    });
}

function rerunSimulation() {
    window.location.reload();
}

function clearOpponent() {
    if (confirm('Are you sure you want to clear the opponent team?')) {
        fetch('/api/save-opponent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ team: [] })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            }
        });
    }
}

// Load credits when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadOpponentCredits();
});

// Initialize modal when opened
document.getElementById('selectOpponentModal')?.addEventListener('shown.bs.modal', function() {
    opponentTeam = [];
    opponentRoster = {
        PG: null, SG: null, G: null, SF: null, PF: null,
        F: null, C1: null, C2: null, UTIL1: null, UTIL2: null
    };
    updateOpponentModal();
    updateOpponentRosterStatus();
    updateOppCreditDisplay();
    validateOppTeam();
    applyOppFilters();
});
</script>

{% endblock %}
